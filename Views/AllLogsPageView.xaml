<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
	x:Class="WorkLog.Views.AllLogsPageView"
	xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
	xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
	xmlns:models="clr-namespace:WorkLog.Models"
	xmlns:vm="clr-namespace:WorkLog.ViewModels"
	x:DataType="vm:AllLogsPageViewModel">

	<ContentPage.Resources>
		<ResourceDictionary>
			<converters:EnumToDescriptionConverter xmlns:converters="clr-namespace:WorkLog.Converters" x:Key="EnumDescriptionConverter" />
			<converters:IsNotNullOrEmptyConverter xmlns:converters="clr-namespace:WorkLog.Converters" x:Key="IsNotNullOrEmptyConverter" />
		</ResourceDictionary>
	</ContentPage.Resources>

	<Grid RowDefinitions="Auto, *">
		<Border
			Grid.Row="0"
			Margin="15"
			Padding="15">
			<VerticalStackLayout Spacing="10">
				<Label FontAttributes="Bold" Text="筛选条件" />
				<HorizontalStackLayout HorizontalOptions="Center" Spacing="10">
					<DatePicker Date="{Binding FilterStartDate}" />
					<Label Text=" 至 " VerticalOptions="Center" />
					<DatePicker Date="{Binding FilterEndDate}" />
				</HorizontalStackLayout>
				<HorizontalStackLayout HorizontalOptions="Center" Spacing="10">
					<Picker
						Title="按类型筛选..."
						ItemsSource="{Binding Source={x:Static models:EventTypeExtensions.All}}"
						SelectedItem="{Binding SelectedFilterType}" />
					<Picker
						Title="按状态筛选..."
						ItemsSource="{Binding Source={x:Static models:EventStatusExtensions.All}}"
						SelectedItem="{Binding SelectedFilterStatus}" />
				</HorizontalStackLayout>
			</VerticalStackLayout>
		</Border>

		<Grid Grid.Row="1" Margin="15,0">
			<StackLayout
				HorizontalOptions="Center"
				IsVisible="False"
				Spacing="10"
				VerticalOptions="Center">
				<ActivityIndicator IsRunning="True" />
				<Label Text="正在加载日志..." TextColor="{StaticResource Gray400}" />
				<StackLayout.Triggers>
					<DataTrigger
						Binding="{Binding CurrentState}"
						TargetType="StackLayout"
						Value="Loading">
						<Setter Property="IsVisible" Value="True" />
					</DataTrigger>
				</StackLayout.Triggers>
			</StackLayout>

			<VerticalStackLayout
				HorizontalOptions="Center"
				IsVisible="False"
				Spacing="10"
				VerticalOptions="Center">
				<Label
					FontFamily="FluentIcons"
					FontSize="48"
					HorizontalOptions="Center"
					Text="&#xE783;"
					TextColor="{StaticResource Gray300}" />
				<Label
					FontAttributes="Bold"
					FontSize="16"
					HorizontalOptions="Center"
					Text="{Binding EmptyViewTitle}"
					TextColor="{StaticResource Gray500}" />
				<Label
					HorizontalOptions="Center"
					Text="{Binding EmptyViewSubtitle}"
					TextColor="{StaticResource Gray400}" />
				<VerticalStackLayout.Triggers>
					<DataTrigger
						Binding="{Binding CurrentState}"
						TargetType="StackLayout"
						Value="Empty">
						<Setter Property="IsVisible" Value="True" />
					</DataTrigger>
				</VerticalStackLayout.Triggers>
			</VerticalStackLayout>

			<CollectionView
				IsGrouped="True"
				IsVisible="False"
				ItemsSource="{Binding GroupedEvents}">
				<CollectionView.Triggers>
					<DataTrigger
						Binding="{Binding CurrentState}"
						TargetType="CollectionView"
						Value="Normal">
						<Setter Property="IsVisible" Value="True" />
					</DataTrigger>
				</CollectionView.Triggers>

				<CollectionView.ItemsLayout>
					<LinearItemsLayout ItemSpacing="15" Orientation="Vertical" />
				</CollectionView.ItemsLayout>

				<CollectionView.GroupHeaderTemplate>
					<DataTemplate x:DataType="models:LogGroup">
						<Label
							Padding="10"
							BackgroundColor="{StaticResource Gray100}"
							FontAttributes="Bold"
							Text="{Binding Title}" />
					</DataTemplate>
				</CollectionView.GroupHeaderTemplate>

				<CollectionView.ItemTemplate>
					<DataTemplate x:DataType="models:WorkEvent">
						<Border
							Padding="15"
							Stroke="{AppThemeBinding Light=#E0E0E0,
							                         Dark=#404040}"
							StrokeThickness="1">
							<Border.StrokeShape>
								<RoundRectangle CornerRadius="8" />
							</Border.StrokeShape>

							<Border.Shadow>
								<Shadow
									Brush="Black"
									Opacity="0.1"
									Radius="8"
									Offset="3,3" />
							</Border.Shadow>

							<VerticalStackLayout Spacing="10">
								<Label
									FontAttributes="Bold"
									FontFamily="MapleMono"
									FontSize="Micro"
									Text="{Binding Title, Mode=OneWay}" />

								<Label
									FontFamily="MapleMono"
									FontSize="14"
									LineBreakMode="WordWrap"
									MaxLines="5"
									Text="{Binding Description, Mode=OneWay}"
									TextColor="{StaticResource Gray600}" />

								<Border
									IsVisible="{Binding Remarks, Converter={StaticResource IsNotNullOrEmptyConverter}}"
									Stroke="{AppThemeBinding Light={StaticResource Gray200},
									                         Dark={StaticResource Gray600}}"
									StrokeThickness="1">
									<Border.StrokeShape>
										<RoundRectangle CornerRadius="6" />
									</Border.StrokeShape>

									<Grid ColumnDefinitions="Auto, *">
										<BoxView
											Grid.Column="0"
											Margin="-15,-10"
											WidthRequest="3"
											Color="{StaticResource Primary}" />

										<VerticalStackLayout
											Grid.Column="1"
											Padding="15,10"
											Spacing="5">
											<Label
												FontAttributes="Italic"
												FontSize="Caption"
												Text="备注:"
												TextColor="{StaticResource Gray500}" />
											<Label
												FontFamily="MapleMono"
												FontSize="Caption"
												LineBreakMode="TailTruncation"
												MaxLines="3"
												Text="{Binding Remarks, Mode=OneWay}" />
										</VerticalStackLayout>
									</Grid>
								</Border>

								<BoxView HeightRequest="1" Color="{StaticResource Gray200}" />

								<Grid
									ColumnDefinitions="Auto, Auto, Auto, *, Auto"
									ColumnSpacing="10"
									VerticalOptions="Center">
									<Label
										Grid.Column="0"
										FontSize="Caption"
										Text="{Binding EventType, Converter={StaticResource EnumDescriptionConverter}, Mode=OneWay}"
										TextColor="{StaticResource Primary}" />

									<BoxView
										Grid.Column="1"
										Margin="0,2"
										VerticalOptions="Fill"
										WidthRequest="1"
										Color="{StaticResource Gray300}" />

									<Label
										Grid.Column="2"
										FontSize="Caption"
										Text="{Binding Status, Converter={StaticResource EnumDescriptionConverter}, Mode=OneWay}"
										TextColor="{StaticResource Primary}" />

									<Label
										Grid.Column="4"
										FontSize="Caption"
										HorizontalOptions="End"
										Text="{Binding Timestamp, StringFormat='{0:yyyy-MM-dd HH:mm}', Mode=OneWay}"
										TextColor="{StaticResource Gray500}" />
								</Grid>
							</VerticalStackLayout>
						</Border>
					</DataTemplate>
				</CollectionView.ItemTemplate>
			</CollectionView>
		</Grid>
	</Grid>
</ContentPage>
